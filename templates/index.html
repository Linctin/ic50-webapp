<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IC50 計算與儲存工具</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 20px; background-color: #f4f7f6; color: #333; }
        .container { max-width: 1200px; margin: auto; background-color: #ffffff; padding: 30px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        h1, h2 { color: #2c3e50; border-bottom: 2px solid #e0e0e0; padding-bottom: 10px; margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: bold; color: #555; }
        input[type="text"], input[type="number"] { width: calc(100% - 22px); padding: 10px; border: 1px solid #ccc; border-radius: 5px; margin-bottom: 15px; }
        button { background-color: #4CAF50; color: white; padding: 12px 25px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; margin: 10px 5px; transition: background-color 0.3s ease; }
        button.remove-btn { background-color: #f44336; }
        button.remove-row-btn { background-color: #e74c3c; padding: 5px 10px; font-size: 12px; margin-left: 10px; }
        button:hover { opacity: 0.9; }
        .experiment-block { border: 1px solid #ddd; padding: 20px; margin-bottom: 20px; border-radius: 8px; background-color: #fafafa; }
        .data-row { display: flex; align-items: center; margin-bottom: 10px; }
        .data-row label, .data-row input { margin-right: 10px; }
        .data-row input { width: 100px; }
        .error-message { color: red; font-weight: bold; margin-top: 10px; }
        .nav { margin-bottom: 20px; }
        .nav a { text-decoration: none; background-color: #6c757d; color: white; padding: 10px 20px; border-radius: 5px; margin-right: 10px; }
        .nav a:hover { background-color: #5a6268; }
        #organoid-id-section { margin-bottom: 30px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="nav">
            <a href="/">IC50 計算器</a>
            <a href="/dashboard">儀表板</a>
        </div>

        <h1>IC50 計算與儲存</h1>
        <p>為一個類器官 (Organoid) 輸入三種藥物 (5FU, Irinotecan, Oxaliplatin) 的數據，計算 IC50 並將結果儲存到儀表板。</p>

        <div id="organoid-id-section">
            <label for="organoid-id">Organoid ID:</label>
            <input type="text" id="organoid-id" placeholder="例如: PatientX-Tumor1">
        </div>

        <div id="experiments-container">
            <!-- 實驗區塊將通過 JavaScript 動態插入 -->
        </div>

        <button onclick="submitToDashboard()" style="background-color: #007bff;">計算並儲存至儀表板</button>

        <div id="error-message" class="error-message"></div>
    </div>

    <template id="experiment-template">
        <div class="experiment-block">
            <h3>實驗數據: <span class="drug-name-display"></span></h3>
            <input type="hidden" class="experiment-name">
            
            <label>無藥物對照組吸光值 (Control):</label>
            <input type="number" class="control_abs" step="0.001" required>

            <label>背景吸光值 (Background):</label>
            <input type="number" class="background_abs" step="0.001" required>

            <h4>數據輸入</h4>
            <div class="data-inputs">
                <div class="data-row header">
                    <label style="width: 100px;">濃度</label>
                    <label style="width: 100px;">重複 1</label>
                    <label style="width: 100px;">重複 2</label>
                    <label style="width: 100px;">重複 3</label>
                </div>
            </div>
            <button onclick="addDataRow(this)">新增一行數據</button>
        </div>
    </template>

    <script>
        const requiredDrugs = ["5FU", "Irinotecan", "Oxaliplatin"];

        function addExperiment(drugName) {
            const template = document.getElementById('experiment-template').content.cloneNode(true);
            const experimentBlock = template.querySelector('.experiment-block');
            
            experimentBlock.querySelector('.drug-name-display').textContent = drugName;
            experimentBlock.querySelector('.experiment-name').value = drugName;

            const dataInputs = experimentBlock.querySelector('.data-inputs');
            for (let i = 0; i < 5; i++) { // Add 5 default rows
                dataInputs.appendChild(createDataRow());
            }

            document.getElementById('experiments-container').appendChild(template);
        }

        function addDataRow(button) {
            const dataInputs = button.previousElementSibling;
            dataInputs.appendChild(createDataRow());
        }
        
        function createDataRow() {
            const newRow = document.createElement('div');
            newRow.className = 'data-row';
            newRow.innerHTML = `
                <input type="number" class="concentration" step="0.1" placeholder="濃度">
                <input type="number" class="replicate" step="0.001" placeholder="重複1">
                <input type="number" class="replicate" step="0.001" placeholder="重複2">
                <input type="number" class="replicate" step="0.001" placeholder="重複3">
                <button class="remove-row-btn" onclick="this.parentElement.remove()">刪除</button>
            `;
            return newRow;
        }

        async function submitToDashboard() {
            const errorMessageDiv = document.getElementById('error-message');
            errorMessageDiv.textContent = '';

            const organoidId = document.getElementById('organoid-id').value.trim();
            if (!organoidId) {
                errorMessageDiv.textContent = "請務必填寫 Organoid ID。";
                return;
            }

            const experiments = [];
            const experimentBlocks = document.querySelectorAll('.experiment-block');

            for (const block of experimentBlocks) {
                const name = block.querySelector('.experiment-name').value;
                const controlAbs = parseFloat(block.querySelector('.control_abs').value);
                const backgroundAbs = parseFloat(block.querySelector('.background_abs').value);

                if (isNaN(controlAbs) || isNaN(backgroundAbs)) {
                    errorMessageDiv.textContent = `實驗 "${name}" 的對照組或背景值無效。`;
                    return;
                }

                const concentrations = [];
                const rawReplicates = [];
                const dataRows = block.querySelectorAll('.data-row:not(.header)');

                dataRows.forEach(row => {
                    const concInput = row.querySelector('.concentration');
                    const conc = parseFloat(concInput.value);
                    if (isNaN(conc)) return;

                    concentrations.push(conc);
                    
                    const repInputs = row.querySelectorAll('.replicate');
                    let currentReps = [];
                    repInputs.forEach(input => {
                        const repVal = parseFloat(input.value);
                        currentReps.push(isNaN(repVal) ? null : repVal);
                    });
                    rawReplicates.push(currentReps);
                });
                
                if (concentrations.length > 0) {
                    experiments.push({
                        name: name,
                        concentrations: concentrations,
                        raw_replicates: rawReplicates,
                        control_abs: controlAbs,
                        background_abs: backgroundAbs
                    });
                }
            }

            if (experiments.length < requiredDrugs.length) {
                errorMessageDiv.textContent = "請為所有三種藥物輸入數據。";
                return;
            }

            try {
                const response = await fetch('/calculate_and_store', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ organoid_id: organoidId, experiments: experiments })
                });

                const result = await response.json();

                if (response.ok) {
                    // On success, redirect to the dashboard
                    window.location.href = result.redirect_url;
                } else {
                    errorMessageDiv.textContent = '計算失敗: ' + (result.error || '未知錯誤');
                }

            } catch (error) {
                errorMessageDiv.textContent = '與伺服器通訊發生錯誤: ' + error.message;
                console.error('Error:', error);
            }
        }
        
        // Add the three required experiment blocks by default on page load
        window.onload = () => {
            requiredDrugs.forEach(drug => addExperiment(drug));
        };
    </script>
</body>
</html>