<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>多曲線 IC50 計算與繪圖工具</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 20px; background-color: #f4f7f6; color: #333; }
        .container { max-width: 1200px; margin: auto; background-color: #ffffff; padding: 30px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        h1, h2 { color: #2c3e50; border-bottom: 2px solid #e0e0e0; padding-bottom: 10px; margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: bold; color: #555; }
        input[type="text"], input[type="number"] { width: calc(100% - 20px); padding: 8px; border: 1px solid #ccc; border-radius: 5px; margin-bottom: 10px; }
        button { background-color: #4CAF50; color: white; padding: 12px 25px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; margin: 10px 5px; transition: background-color 0.3s ease; }
        button.remove-btn { background-color: #f44336; }
        button.remove-row-btn { background-color: #e74c3c; padding: 5px 10px; font-size: 12px; margin-left: 10px; }
        button:hover { opacity: 0.9; }
        .experiment-block { border: 1px solid #ddd; padding: 20px; margin-bottom: 20px; border-radius: 8px; background-color: #fafafa; }
        .data-row { display: flex; align-items: center; margin-bottom: 10px; }
        .data-row label, .data-row input { margin-right: 10px; }
        .data-row input { width: 100px; }
        .results-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .results-table th, .results-table td { border: 1px solid #ddd; padding: 12px; text-align: left; }
        .results-table th { background-color: #e2eafc; }
        #plot-area img { max-width: 100%; height: auto; display: block; margin: 20px auto; border: 1px solid #e0e0e0; border-radius: 5px; }
        .error-message { color: red; font-weight: bold; margin-top: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>多曲線 IC50 計算與繪圖工具</h1>
        <p>點擊 "新增實驗" 來加入多組數據進行比較。每組實驗都可以有獨立的對照組和背景值。</p>

        <div id="experiments-container">
            <!-- 實驗區塊將通過 JavaScript 動態插入 -->
        </div>

        <button onclick="addExperiment()">新增實驗</button>
        <button onclick="calculate()" style="background-color: #007bff;">計算 IC50 並繪圖</button>

        <div id="error-message" class="error-message"></div>

        <div id="results-section" style="display:none;">
            <h2>計算結果</h2>
            <table class="results-table">
                <thead>
                    <tr>
                        <th>實驗名稱</th>
                        <th>IC50</th>
                        <th>Top</th>
                        <th>Bottom</th>
                        <th>HillSlope</th>
                    </tr>
                </thead>
                <tbody id="results-tbody">
                </tbody>
            </table>
        </div>

        <div id="plot-area" style="display:none;">
            <h2>劑量反應曲線</h2>
            <img id="dose-response-plot" src="" alt="IC50 劑量反應曲線將顯示在這裡">
        </div>
    </div>

    <template id="experiment-template">
        <div class="experiment-block">
            <button class="remove-btn" onclick="this.parentElement.remove()">移除此實驗</button>
            <h3>實驗數據</h3>
            <label>實驗名稱:</label>
            <input type="text" class="experiment-name" placeholder="例如: Organoid A, Drug X">
            
            <label>無藥物對照組吸光值 (Control):</label>
            <input type="number" class="control_abs" step="0.001" required>

            <label>背景吸光值 (Background):</label>
            <input type="number" class="background_abs" step="0.001" required>

            <h4>數據輸入</h4>
            <div class="data-inputs">
                <div class="data-row header">
                    <label style="width: 100px;">濃度</label>
                    <label style="width: 100px;">重複 1</label>
                    <label style="width: 100px;">重複 2</label>
                    <label style="width: 100px;">重複 3</label>
                </div>
                <!-- 數據行將動態添加 -->
            </div>
            <button onclick="addDataRow(this)">新增一行數據</button>
        </div>
    </template>

    <script>
        let experimentCounter = 0;

        function addExperiment() {
            experimentCounter++;
            const template = document.getElementById('experiment-template').content.cloneNode(true);
            const experimentBlock = template.querySelector('.experiment-block');
            experimentBlock.dataset.id = experimentCounter;
            
            const nameInput = experimentBlock.querySelector('.experiment-name');
            nameInput.placeholder = `例如: Organoid ${experimentCounter}, Drug X`;
            nameInput.value = `實驗 ${experimentCounter}`;

            // Add a few default data rows
            const dataInputs = experimentBlock.querySelector('.data-inputs');
            for (let i = 0; i < 4; i++) {
                dataInputs.appendChild(createDataRow());
            }

            document.getElementById('experiments-container').appendChild(template);
        }

        function addDataRow(button) {
            const dataInputs = button.previousElementSibling;
            dataInputs.appendChild(createDataRow());
        }
        
        function createDataRow() {
            const newRow = document.createElement('div');
            newRow.className = 'data-row';
            newRow.innerHTML = `
                <input type="number" class="concentration" step="0.1" placeholder="濃度">
                <input type="number" class="replicate" step="0.001" placeholder="重複1">
                <input type="number" class="replicate" step="0.001" placeholder="重複2">
                <input type="number" class="replicate" step="0.001" placeholder="重複3">
                <button class="remove-row-btn" onclick="this.parentElement.remove()">刪除</button>
            `;
            return newRow;
        }

        async function calculate() {
            const errorMessageDiv = document.getElementById('error-message');
            errorMessageDiv.textContent = '';

            const experiments = [];
            const experimentBlocks = document.querySelectorAll('.experiment-block');

            for (const block of experimentBlocks) {
                const name = block.querySelector('.experiment-name').value.trim() || `實驗 ${block.dataset.id}`;
                const controlAbs = parseFloat(block.querySelector('.control_abs').value);
                const backgroundAbs = parseFloat(block.querySelector('.background_abs').value);

                if (isNaN(controlAbs) || isNaN(backgroundAbs)) {
                    errorMessageDiv.textContent = `實驗 "${name}" 的對照組或背景值無效。`;
                    return;
                }

                const concentrations = [];
                const rawReplicates = [];
                const dataRows = block.querySelectorAll('.data-row:not(.header)');

                dataRows.forEach(row => {
                    const concInput = row.querySelector('.concentration');
                    const conc = parseFloat(concInput.value);
                    if (isNaN(conc)) return;

                    concentrations.push(conc);
                    
                    const repInputs = row.querySelectorAll('.replicate');
                    let currentReps = [];
                    repInputs.forEach(input => {
                        const repVal = parseFloat(input.value);
                        currentReps.push(isNaN(repVal) ? null : repVal);
                    });
                    rawReplicates.push(currentReps);
                });
                
                if (concentrations.length > 0) {
                    experiments.push({
                        name: name,
                        concentrations: concentrations,
                        raw_replicates: rawReplicates,
                        control_abs: controlAbs,
                        background_abs: backgroundAbs
                    });
                }
            }

            if (experiments.length === 0) {
                errorMessageDiv.textContent = "請至少輸入一組有效的實驗數據。";
                return;
            }

            try {
                const response = await fetch('/calculate_ic50', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ experiments: experiments })
                });

                const result = await response.json();

                if (response.ok) {
                    const resultsTbody = document.getElementById('results-tbody');
                    resultsTbody.innerHTML = ''; // Clear previous results
                    result.results.forEach(res => {
                        const row = `<tr>
                            <td>${res.name}</td>
                            <td>${res.ic50}</td>
                            <td>${res.top}</td>
                            <td>${res.bottom}</td>
                            <td>${res.hillslope}</td>
                        </tr>`;
                        resultsTbody.innerHTML += row;
                    });

                    document.getElementById('results-section').style.display = 'block';
                    document.getElementById('plot-area').style.display = 'block';
                    document.getElementById('dose-response-plot').src = result.plot_image;
                } else {
                    errorMessageDiv.textContent = '計算失敗: ' + (result.error || '未知錯誤');
                }

            } catch (error) {
                errorMessageDiv.textContent = '與伺服器通訊發生錯誤: ' + error.message;
                console.error('Error:', error);
            }
        }
        
        // Add one experiment block by default on page load
        window.onload = () => {
            addExperiment();
        };
    </script>
</body>
</html>
